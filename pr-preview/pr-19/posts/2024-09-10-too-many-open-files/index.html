<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="The personal site of Ross Gardiner"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate" type="application/rss+xml" title="Ross Gardiner's blog" href="https://rossng.eu/feed.xml"><meta name="generator" content="Astro v5.1.2"><title>Ross Gardiner ⌁ Too many open files (os error 24)
</title><link rel="stylesheet" href="/_astro/index.AdgwLHRZ.css">
<style>[data-astro-image]{width:100%;height:auto;-o-object-fit:var(--fit);object-fit:var(--fit);-o-object-position:var(--pos);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body class="bg-gradient-to-r from-[#ff7e5f] to-[#feb47b] w-full min-h-screen bg-no-repeat bg-cover"> <header class="bg-white"> <div class="max-w-7xl mx-auto flex justify-between items-center p-4"> <div class="flex items-center"> <a href="/"> <img src="/favicon.svg" alt="Favicon" class="w-6 h-6 mr-2" title="Mysterious U+237C"> </a> <h1 class="text-xl font-bold text-gray-900"> <a href="/">Ross Gardiner</a> </h1> </div> <nav class="flex items-center space-x-4 text-gray-700"> <a href="/posts">Posts</a> </nav> </div> </header> <div class="prose max-w-3xl mx-auto p-4 m-4 bg-white text-gray-900 shadow-md">   <div class="mb-2"> <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100"> Too many open files (os error 24)
 </h1> <p class="text-sm text-gray-500 dark:text-gray-400"> 2024-09-10 </p> </div> <p>Sometimes you might encounter an error message like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="plaintext"><code><span class="line"><span>Too many open files (os error 24)</span></span></code></pre>
<p>Too many open files? That seems clear enough. A bit of googling—or prodding of your preferred LLM—will tell you that
this is caused by the nofiles ulimit. Easy to solve. Except you then increase that limit to something huge like a million, and the error doesn’t go away.</p>
<p>There is another possibility: in your application you are watching files for changes, and you are hitting a different
limit. File watching on Linux (generally) uses inotify internally, and that has its own limits (which are helpfully configured in a completely different
place). Those limits are <code>max_user_instances</code>, <code>max_user_watches</code> and <code>max_queued_events</code> (<a href="https://man7.org/linux/man-pages/man7/inotify.7.html">see inotify(7) man for more details</a>).</p>
<p>You can manually set these limits using <code>sysctl</code>. For example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">sysctl</span><span style="color:#79B8FF"> -w</span><span style="color:#9ECBFF"> fs.inotify.max_user_instances=</span><span style="color:#79B8FF">8192</span></span></code></pre>
<p>I ran into this because <code>max_user_instances</code> <a href="https://github.com/NixOS/nixpkgs/issues/36214">defaults to 128</a>(!) on NixOS.
As an ivory tower-enjoying NixOS user, you will of course instead want to set your limits like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="nix"><code><span class="line"><span style="color:#FFAB70">boot</span><span style="color:#F97583">.</span><span style="color:#FFAB70">kernel</span><span style="color:#F97583">.</span><span style="color:#FFAB70">sysctl</span><span style="color:#FDAEB7;font-style:italic"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;fs.inotify.max_user_instances&quot;</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> &quot;8192&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span><span style="color:#FDAEB7;font-style:italic">;</span></span></code></pre>   </div> <footer class="text-center text-xs mt-4 mb-4"> <a href="https://github.com/rossng/rossng.github.io/blob/main/README.md" class="text-gray-500">&copy;</a> </footer> </body></html>